import * as tslib_1 from "tslib";
import { ChangeDetectionStrategy, Component, ContentChild, ElementRef, EmbeddedViewRef, IterableDiffer, IterableDiffers, NgZone, SimpleChanges, TrackByFunction } from '@angular/core';
import { ProxyCmp } from '../proxies-utils';
import { VirtualFooter } from './virtual-footer';
import { VirtualHeader } from './virtual-header';
import { VirtualItem } from './virtual-item';
import * as ɵngcc0 from '@angular/core';

var _c0 = ["*"];
var IonVirtualScroll = /** @class */ (function () {
    function IonVirtualScroll(z, iterableDiffers, elementRef) {
        this.z = z;
        this.iterableDiffers = iterableDiffers;
        this.refMap = new WeakMap();
        this.el = elementRef.nativeElement;
        this.el.nodeRender = this.nodeRender.bind(this);
    }
    IonVirtualScroll.prototype.ngOnChanges = function (changes) {
        if (this.trackBy && 'items' in changes) {
            // React on virtualScroll changes only once all inputs have been initialized
            var value = changes['items'].currentValue;
            if (this.differ === undefined && value != null) {
                try {
                    this.differ = this.iterableDiffers.find(value).create(this.trackBy);
                }
                catch (e) {
                    throw new Error("Cannot find a differ supporting object '" + value + "'. VirtualScroll only supports binding to Iterables such as Arrays.");
                }
            }
        }
    };
    IonVirtualScroll.prototype.ngDoCheck = function () {
        // and if there actually are changes
        var changes = this.differ !== undefined && this.items ? this.differ.diff(this.items) : null;
        if (changes === null) {
            return;
        }
        // TODO: optimize
        this.checkRange(0);
    };
    IonVirtualScroll.prototype.nodeRender = function (el, cell, index) {
        var _this = this;
        return this.z.run(function () {
            var node;
            if (!el) {
                node = _this.itmTmp.viewContainer.createEmbeddedView(_this.getComponent(cell.type), { $implicit: cell.value, index: index }, index);
                el = getElement(node);
                _this.refMap.set(el, node);
            }
            else {
                node = _this.refMap.get(el);
                var ctx = node.context;
                ctx.$implicit = cell.value;
                ctx.index = cell.index;
            }
            // run sync change detections
            node.detectChanges();
            return el;
        });
    };
    IonVirtualScroll.prototype.getComponent = function (type) {
        switch (type) {
            case 'item': return this.itmTmp.templateRef;
            case 'header': return this.hdrTmp.templateRef;
            case 'footer': return this.ftrTmp.templateRef;
        }
        throw new Error('template for virtual item was not provided');
    };
    IonVirtualScroll.ctorParameters = function () { return [
        { type: NgZone },
        { type: IterableDiffers },
        { type: ElementRef }
    ]; };
    tslib_1.__decorate([
        ContentChild(VirtualItem, { static: false })
    ], IonVirtualScroll.prototype, "itmTmp", void 0);
    tslib_1.__decorate([
        ContentChild(VirtualHeader, { static: false })
    ], IonVirtualScroll.prototype, "hdrTmp", void 0);
    tslib_1.__decorate([
        ContentChild(VirtualFooter, { static: false })
    ], IonVirtualScroll.prototype, "ftrTmp", void 0);
    IonVirtualScroll = tslib_1.__decorate([
        ProxyCmp({
            inputs: ['approxItemHeight', 'approxHeaderHeight', 'approxFooterHeight', 'headerFn', 'footerFn', 'items', 'itemHeight', 'headerHeight', 'footerHeight'],
            methods: ['checkEnd', 'checkRange', 'positionForItem']
        }),
    ], IonVirtualScroll);
IonVirtualScroll.ɵfac = function IonVirtualScroll_Factory(t) { return new (t || IonVirtualScroll)(ɵngcc0.ɵɵdirectiveInject(ɵngcc0.NgZone), ɵngcc0.ɵɵdirectiveInject(ɵngcc0.IterableDiffers), ɵngcc0.ɵɵdirectiveInject(ɵngcc0.ElementRef)); };
IonVirtualScroll.ɵcmp = ɵngcc0.ɵɵdefineComponent({ type: IonVirtualScroll, selectors: [["ion-virtual-scroll"]], contentQueries: function IonVirtualScroll_ContentQueries(rf, ctx, dirIndex) { if (rf & 1) {
        ɵngcc0.ɵɵcontentQuery(dirIndex, VirtualItem, true);
        ɵngcc0.ɵɵcontentQuery(dirIndex, VirtualHeader, true);
        ɵngcc0.ɵɵcontentQuery(dirIndex, VirtualFooter, true);
    } if (rf & 2) {
        var _t;
        ɵngcc0.ɵɵqueryRefresh(_t = ɵngcc0.ɵɵloadQuery()) && (ctx.itmTmp = _t.first);
        ɵngcc0.ɵɵqueryRefresh(_t = ɵngcc0.ɵɵloadQuery()) && (ctx.hdrTmp = _t.first);
        ɵngcc0.ɵɵqueryRefresh(_t = ɵngcc0.ɵɵloadQuery()) && (ctx.ftrTmp = _t.first);
    } }, inputs: { approxItemHeight: "approxItemHeight", approxHeaderHeight: "approxHeaderHeight", approxFooterHeight: "approxFooterHeight", headerFn: "headerFn", footerFn: "footerFn", items: "items", itemHeight: "itemHeight", headerHeight: "headerHeight", footerHeight: "footerHeight", trackBy: "trackBy" }, features: [ɵngcc0.ɵɵNgOnChangesFeature], ngContentSelectors: _c0, decls: 1, vars: 0, template: function IonVirtualScroll_Template(rf, ctx) { if (rf & 1) {
        ɵngcc0.ɵɵprojectionDef();
        ɵngcc0.ɵɵprojection(0);
    } }, encapsulation: 2, changeDetection: 0 });
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(IonVirtualScroll, [{
        type: Component,
        args: [{
                selector: 'ion-virtual-scroll',
                template: '<ng-content></ng-content>',
                changeDetection: ChangeDetectionStrategy.OnPush,
                inputs: [
                    'approxItemHeight',
                    'approxHeaderHeight',
                    'approxFooterHeight',
                    'headerFn',
                    'footerFn',
                    'items',
                    'itemHeight',
                    'headerHeight',
                    'footerHeight',
                    'trackBy'
                ]
            }]
    }], function () { return [{ type: ɵngcc0.NgZone }, { type: ɵngcc0.IterableDiffers }, { type: ɵngcc0.ElementRef }]; }, { itmTmp: [{
            type: ContentChild,
            args: [VirtualItem, { static: false }]
        }], hdrTmp: [{
            type: ContentChild,
            args: [VirtualHeader, { static: false }]
        }], ftrTmp: [{
            type: ContentChild,
            args: [VirtualFooter, { static: false }]
        }] }); })();
    return IonVirtualScroll;
}());
export { IonVirtualScroll };
var getElement = function (view) {
    var rootNodes = view.rootNodes;
    for (var i = 0; i < rootNodes.length; i++) {
        if (rootNodes[i].nodeType === 1) {
            return rootNodes[i];
        }
    }
    throw new Error('virtual element was not created');
};
var ɵ0 = getElement;
export { ɵ0 };

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmlydHVhbC1zY3JvbGwuanMiLCJzb3VyY2VzIjpbIm5nOi9AaW9uaWMvYW5ndWxhci9kaXJlY3RpdmVzL3ZpcnR1YWwtc2Nyb2xsL3ZpcnR1YWwtc2Nyb2xsLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsdUJBQXVCLEVBQUUsU0FBUyxFQUFFLFlBQVksRUFBRSxVQUFVLEVBQUUsZUFBZSxFQUFFLGNBQWMsRUFBRSxlQUFlLEVBQUUsTUFBTSxFQUFFLGFBQWEsRUFBRSxlQUFlLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFHdkwsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBRTVDLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUNqRCxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDakQsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLGdCQUFnQixDQUFDOzs7O0FBZ0k3QztJQVVFLDBCQUNVLENBQVMsRUFDVCxlQUFnQyxFQUN4QyxVQUFzQjtRQUZkLE1BQUMsR0FBRCxDQUFDLENBQVE7UUFDVCxvQkFBZSxHQUFmLGVBQWUsQ0FBaUI7UUFSbEMsV0FBTSxHQUFHLElBQUksT0FBTyxFQUFnRCxDQUFDO1FBVzNFLElBQUksQ0FBQyxFQUFFLEdBQUcsVUFBVSxDQUFDLGFBQTRDLENBQUM7UUFDbEUsSUFBSSxDQUFDLEVBQUUsQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDbEQsQ0FBQztJQUVELHNDQUFXLEdBQVgsVUFBWSxPQUFzQjtRQUNoQyxJQUFJLElBQUksQ0FBQyxPQUFPLElBQUksT0FBTyxJQUFJLE9BQU8sRUFBRTtZQUN0Qyw0RUFBNEU7WUFDNUUsSUFBTSxLQUFLLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDLFlBQVksQ0FBQztZQUM1QyxJQUFJLElBQUksQ0FBQyxNQUFNLEtBQUss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QyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3ksIENvbXBvbmVudCwgQ29udGVudENoaWxkLCBFbGVtZW50UmVmLCBFbWJlZGRlZFZpZXdSZWYsIEl0ZXJhYmxlRGlmZmVyLCBJdGVyYWJsZURpZmZlcnMsIE5nWm9uZSwgU2ltcGxlQ2hhbmdlcywgVHJhY2tCeUZ1bmN0aW9uIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBDZWxsLCBDZWxsVHlwZSwgRm9vdGVySGVpZ2h0Rm4sIEhlYWRlckZuLCBIZWFkZXJIZWlnaHRGbiwgSXRlbUhlaWdodEZuIH0gZnJvbSAnQGlvbmljL2NvcmUnO1xuXG5pbXBvcnQgeyBQcm94eUNtcCB9IGZyb20gJy4uL3Byb3hpZXMtdXRpbHMnO1xuXG5pbXBvcnQgeyBWaXJ0dWFsRm9vdGVyIH0gZnJvbSAnLi92aXJ0dWFsLWZvb3Rlcic7XG5pbXBvcnQgeyBWaXJ0dWFsSGVhZGVyIH0gZnJvbSAnLi92aXJ0dWFsLWhlYWRlcic7XG5pbXBvcnQgeyBWaXJ0dWFsSXRlbSB9IGZyb20gJy4vdmlydHVhbC1pdGVtJztcbmltcG9ydCB7IFZpcnR1YWxDb250ZXh0IH0gZnJvbSAnLi92aXJ0dWFsLXV0aWxzJztcblxuZXhwb3J0IGRlY2xhcmUgaW50ZXJmYWNlIElvblZpcnR1YWxTY3JvbGwge1xuICAvKipcbiAgICogSXQgaXMgaW1wb3J0YW50IHRvIHByb3ZpZGUgdGhpc1xuICAgKiBpZiB2aXJ0dWFsIGl0ZW0gaGVpZ2h0IHdpbGwgYmUgc2lnbmlmaWNhbnRseSBsYXJnZXIgdGhhbiB0aGUgZGVmYXVsdFxuICAgKiBUaGUgYXBwcm94aW1hdGUgaGVpZ2h0IG9mIGVhY2ggdmlydHVhbCBpdGVtIHRlbXBsYXRlJ3MgY2VsbC5cbiAgICogVGhpcyBkaW1lbnNpb24gaXMgdXNlZCB0byBoZWxwIGRldGVybWluZSBob3cgbWFueSBjZWxscyBzaG91bGRcbiAgICogYmUgY3JlYXRlZCB3aGVuIGluaXRpYWxpemVkLCBhbmQgdG8gaGVscCBjYWxjdWxhdGUgdGhlIGhlaWdodCBvZlxuICAgKiB0aGUgc2Nyb2xsYWJsZSBhcmVhLiBUaGlzIGhlaWdodCB2YWx1ZSBjYW4gb25seSB1c2UgYHB4YCB1bml0cy5cbiAgICogTm90ZSB0aGF0IHRoZSBhY3R1YWwgcmVuZGVyZWQgc2l6ZSBvZiBlYWNoIGNlbGwgY29tZXMgZnJvbSB0aGVcbiAgICogYXBwJ3MgQ1NTLCB3aGVyZWFzIHRoaXMgYXBwcm94aW1hdGlvbiBpcyB1c2VkIHRvIGhlbHAgY2FsY3VsYXRlXG4gICAqIGluaXRpYWwgZGltZW5zaW9ucyBiZWZvcmUgdGhlIGl0ZW0gaGFzIGJlZW4gcmVuZGVyZWQuXG4gICAqL1xuICBhcHByb3hJdGVtSGVpZ2h0OiBudW1iZXI7XG5cbiAgLyoqXG4gICAqIFRoZSBhcHByb3hpbWF0ZSBoZWlnaHQgb2YgZWFjaCBoZWFkZXIgdGVtcGxhdGUncyBjZWxsLlxuICAgKiBUaGlzIGRpbWVuc2lvbiBpcyB1c2VkIHRvIGhlbHAgZGV0ZXJtaW5lIGhvdyBtYW55IGNlbGxzIHNob3VsZFxuICAgKiBiZSBjcmVhdGVkIHdoZW4gaW5pdGlhbGl6ZWQsIGFuZCB0byBoZWxwIGNhbGN1bGF0ZSB0aGUgaGVpZ2h0IG9mXG4gICAqIHRoZSBzY3JvbGxhYmxlIGFyZWEuIFRoaXMgaGVpZ2h0IHZhbHVlIGNhbiBvbmx5IHVzZSBgcHhgIHVuaXRzLlxuICAgKiBOb3RlIHRoYXQgdGhlIGFjdHVhbCByZW5kZXJlZCBzaXplIG9mIGVhY2ggY2VsbCBjb21lcyBmcm9tIHRoZVxuICAgKiBhcHAncyBDU1MsIHdoZXJlYXMgdGhpcyBhcHByb3hpbWF0aW9uIGlzIHVzZWQgdG8gaGVscCBjYWxjdWxhdGVcbiAgICogaW5pdGlhbCBkaW1lbnNpb25zIGJlZm9yZSB0aGUgaXRlbSBoYXMgYmVlbiByZW5kZXJlZC5cbiAgICovXG4gIGFwcHJveEhlYWRlckhlaWdodDogbnVtYmVyO1xuXG4gIC8qKlxuICAgKiBUaGUgYXBwcm94aW1hdGUgd2lkdGggb2YgZWFjaCBmb290ZXIgdGVtcGxhdGUncyBjZWxsLlxuICAgKiBUaGlzIGRpbWVuc2lvbiBpcyB1c2VkIHRvIGhlbHAgZGV0ZXJtaW5lIGhvdyBtYW55IGNlbGxzIHNob3VsZFxuICAgKiBiZSBjcmVhdGVkIHdoZW4gaW5pdGlhbGl6ZWQsIGFuZCB0byBoZWxwIGNhbGN1bGF0ZSB0aGUgaGVpZ2h0IG9mXG4gICAqIHRoZSBzY3JvbGxhYmxlIGFyZWEuIFRoaXMgaGVpZ2h0IHZhbHVlIGNhbiBvbmx5IHVzZSBgcHhgIHVuaXRzLlxuICAgKiBOb3RlIHRoYXQgdGhlIGFjdHVhbCByZW5kZXJlZCBzaXplIG9mIGVhY2ggY2VsbCBjb21lcyBmcm9tIHRoZVxuICAgKiBhcHAncyBDU1MsIHdoZXJlYXMgdGhpcyBhcHByb3hpbWF0aW9uIGlzIHVzZWQgdG8gaGVscCBjYWxjdWxhdGVcbiAgICogaW5pdGlhbCBkaW1lbnNpb25zIGJlZm9yZSB0aGUgaXRlbSBoYXMgYmVlbiByZW5kZXJlZC5cbiAgICovXG4gIGFwcHJveEZvb3RlckhlaWdodDogbnVtYmVyO1xuXG4gIC8qKlxuICAgKiBTZWN0aW9uIGhlYWRlcnMgYW5kIHRoZSBkYXRhIHVzZWQgd2l0aGluIGl0cyBnaXZlblxuICAgKiB0ZW1wbGF0ZSBjYW4gYmUgZHluYW1pY2FsbHkgY3JlYXRlZCBieSBwYXNzaW5nIGEgZnVuY3Rpb24gdG8gYGhlYWRlckZuYC5cbiAgICogRm9yIGV4YW1wbGUsIGEgbGFyZ2UgbGlzdCBvZiBjb250YWN0cyB1c3VhbGx5IGhhcyBkaXZpZGVycyBiZXR3ZWVuIGVhY2hcbiAgICogbGV0dGVyIGluIHRoZSBhbHBoYWJldC4gQXBwJ3MgY2FuIHByb3ZpZGUgdGhlaXIgb3duIGN1c3RvbSBgaGVhZGVyRm5gXG4gICAqIHdoaWNoIGlzIGNhbGxlZCB3aXRoIGVhY2ggcmVjb3JkIHdpdGhpbiB0aGUgZGF0YXNldC4gVGhlIGxvZ2ljIHdpdGhpblxuICAgKiB0aGUgaGVhZGVyIGZ1bmN0aW9uIGNhbiBkZWNpZGUgaWYgdGhlIGhlYWRlciB0ZW1wbGF0ZSBzaG91bGQgYmUgdXNlZCxcbiAgICogYW5kIHdoYXQgZGF0YSB0byBnaXZlIHRvIHRoZSBoZWFkZXIgdGVtcGxhdGUuIFRoZSBmdW5jdGlvbiBtdXN0IHJldHVyblxuICAgKiBgbnVsbGAgaWYgYSBoZWFkZXIgY2VsbCBzaG91bGRuJ3QgYmUgY3JlYXRlZC5cbiAgICovXG4gIGhlYWRlckZuPzogSGVhZGVyRm47XG5cbiAgLyoqXG4gICAqIFNlY3Rpb24gZm9vdGVycyBhbmQgdGhlIGRhdGEgdXNlZCB3aXRoaW4gaXRzIGdpdmVuXG4gICAqIHRlbXBsYXRlIGNhbiBiZSBkeW5hbWljYWxseSBjcmVhdGVkIGJ5IHBhc3NpbmcgYSBmdW5jdGlvbiB0byBgZm9vdGVyRm5gLlxuICAgKiBUaGUgbG9naWMgd2l0aGluIHRoZSBmb290ZXIgZnVuY3Rpb24gY2FuIGRlY2lkZSBpZiB0aGUgZm9vdGVyIHRlbXBsYXRlXG4gICAqIHNob3VsZCBiZSB1c2VkLCBhbmQgd2hhdCBkYXRhIHRvIGdpdmUgdG8gdGhlIGZvb3RlciB0ZW1wbGF0ZS4gVGhlIGZ1bmN0aW9uXG4gICAqIG11c3QgcmV0dXJuIGBudWxsYCBpZiBhIGZvb3RlciBjZWxsIHNob3VsZG4ndCBiZSBjcmVhdGVkLlxuICAgKi9cbiAgZm9vdGVyRm4/OiBIZWFkZXJGbjtcblxuICAvKipcbiAgICogVGhlIGRhdGEgdGhhdCBidWlsZHMgdGhlIHRlbXBsYXRlcyB3aXRoaW4gdGhlIHZpcnR1YWwgc2Nyb2xsLlxuICAgKiBJdCdzIGltcG9ydGFudCB0byBub3RlIHRoYXQgd2hlbiB0aGlzIGRhdGEgaGFzIGNoYW5nZWQsIHRoZW4gdGhlXG4gICAqIGVudGlyZSB2aXJ0dWFsIHNjcm9sbCBpcyByZXNldCwgd2hpY2ggaXMgYW4gZXhwZW5zaXZlIG9wZXJhdGlvbiBhbmRcbiAgICogc2hvdWxkIGJlIGF2b2lkZWQgaWYgcG9zc2libGUuXG4gICAqL1xuICBpdGVtcz86IGFueVtdIHwgbnVsbDtcblxuICAvKipcbiAgICogQW4gb3B0aW9uYWwgZnVuY3Rpb24gdGhhdCBtYXBzIGVhY2ggaXRlbSB3aXRoaW4gdGhlaXIgaGVpZ2h0LlxuICAgKiBXaGVuIHRoaXMgZnVuY3Rpb24gaXMgcHJvdmlkZWQsIGhlYXZ5IG9wdGltaXphdGlvbnMgYW5kIGZhc3QgcGF0aCBjYW4gYmUgdGFrZWQgYnlcbiAgICogYGlvbi12aXJ0dWFsLXNjcm9sbGAgbGVhZGluZyB0byBtYXNzaXZlIHBlcmZvcm1hbmNlIGltcHJvdmVtZW50cy5cbiAgICpcbiAgICogVGhpcyBmdW5jdGlvbiBhbGxvd3MgdG8gc2tpcCBhbGwgRE9NIHJlYWRzLCB3aGljaCBjYW4gYmUgRG9pbmcgc28gbGVhZHNcbiAgICogdG8gbWFzc2l2ZSBwZXJmb3JtYW5jZVxuICAgKi9cbiAgaXRlbUhlaWdodD86IEl0ZW1IZWlnaHRGbjtcblxuICAvKipcbiAgICogQW4gb3B0aW9uYWwgZnVuY3Rpb24gdGhhdCBtYXBzIGVhY2ggaXRlbSBoZWFkZXIgd2l0aGluIHRoZWlyIGhlaWdodC5cbiAgICovXG4gIGhlYWRlckhlaWdodD86IEhlYWRlckhlaWdodEZuO1xuXG4gIC8qKlxuICAgKiBBbiBvcHRpb25hbCBmdW5jdGlvbiB0aGF0IG1hcHMgZWFjaCBpdGVtIGZvb3RlciB3aXRoaW4gdGhlaXIgaGVpZ2h0LlxuICAgKi9cbiAgZm9vdGVySGVpZ2h0PzogRm9vdGVySGVpZ2h0Rm47XG5cbiAgLyoqXG4gICAqIFNhbWUgYXMgYG5nRm9yVHJhY2tCeWAgd2hpY2ggY2FuIGJlIHVzZWQgb24gYG5nRm9yYC5cbiAgICovXG4gIHRyYWNrQnk6IFRyYWNrQnlGdW5jdGlvbjxhbnk+O1xuXG4gIC8qKlxuICAgKiBUaGlzIG1ldGhvZCBtYXJrcyB0aGUgdGFpbCB0aGUgaXRlbXMgYXJyYXkgYXMgZGlydHksIHNvIHRoZXkgY2FuIGJlIHJlLXJlbmRlcmVkLiAgSXQncyBlcXVpdmFsZW50IHRvIGNhbGxpbmc6ICBgYGBqcyAgICAqIHZpcnR1YWxTY3JvbGwuY2hlY2tSYW5nZShsYXN0SXRlbUxlbiwgaXRlbXMubGVuZ3RoIC0gbGFzdEl0ZW1MZW4pOyAgICAqIGBgYFxuICAgKi9cbiAgJ2NoZWNrRW5kJzogKCkgPT4gdm9pZDtcbiAgLyoqXG4gICAqIFRoaXMgbWV0aG9kIG1hcmtzIGEgc3Vic2V0IG9mIGl0ZW1zIGFzIGRpcnR5LCBzbyB0aGV5IGNhbiBiZSByZS1yZW5kZXJlZC4gSXRlbXMgc2hvdWxkIGJlIG1hcmtlZCBhcyBkaXJ0eSBhbnkgdGltZSB0aGUgY29udGVudCBvciB0aGVpciBzdHlsZSBjaGFuZ2VzLiAgVGhlIHN1YnNldCBvZiBpdGVtcyB0byBiZSB1cGRhdGVkIGNhbiBhcmUgc3BlY2lmaW5nIGJ5IGFuIG9mZnNldCBhbmQgYSBsZW5ndGguXG4gICAqL1xuICAnY2hlY2tSYW5nZSc6IChvZmZzZXQ6IG51bWJlciwgbGVuPzogbnVtYmVyKSA9PiB2b2lkO1xuICAvKipcbiAgICogUmV0dXJucyB0aGUgcG9zaXRpb24gb2YgdGhlIHZpcnR1YWwgaXRlbSBhdCB0aGUgZ2l2ZW4gaW5kZXguXG4gICAqL1xuICAncG9zaXRpb25Gb3JJdGVtJzogKGluZGV4OiBudW1iZXIpID0+IFByb21pc2U8bnVtYmVyPjtcbn1cblxuQFByb3h5Q21wKHtcbiAgaW5wdXRzOiBbJ2FwcHJveEl0ZW1IZWlnaHQnLCAnYXBwcm94SGVhZGVySGVpZ2h0JywgJ2FwcHJveEZvb3RlckhlaWdodCcsICdoZWFkZXJGbicsICdmb290ZXJGbicsICdpdGVtcycsICdpdGVtSGVpZ2h0JywgJ2hlYWRlckhlaWdodCcsICdmb290ZXJIZWlnaHQnXSxcbiAgbWV0aG9kczogWydjaGVja0VuZCcsICdjaGVja1JhbmdlJywgJ3Bvc2l0aW9uRm9ySXRlbSddXG59KVxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnaW9uLXZpcnR1YWwtc2Nyb2xsJyxcbiAgdGVtcGxhdGU6ICc8bmctY29udGVudD48L25nLWNvbnRlbnQ+JyxcbiAgY2hhbmdlRGV0ZWN0aW9uOiBDaGFuZ2VEZXRlY3Rpb25TdHJhdGVneS5PblB1c2gsXG4gIGlucHV0czogW1xuICAgICdhcHByb3hJdGVtSGVpZ2h0JyxcbiAgICAnYXBwcm94SGVhZGVySGVpZ2h0JyxcbiAgICAnYXBwcm94Rm9vdGVySGVpZ2h0JyxcbiAgICAnaGVhZGVyRm4nLFxuICAgICdmb290ZXJGbicsXG4gICAgJ2l0ZW1zJyxcbiAgICAnaXRlbUhlaWdodCcsXG4gICAgJ2hlYWRlckhlaWdodCcsXG4gICAgJ2Zvb3RlckhlaWdodCcsXG4gICAgJ3RyYWNrQnknXG4gIF1cbn0pXG5leHBvcnQgY2xhc3MgSW9uVmlydHVhbFNjcm9sbCB7XG5cbiAgcHJpdmF0ZSBkaWZmZXI/OiBJdGVyYWJsZURpZmZlcjxhbnk+O1xuICBwcml2YXRlIGVsOiBIVE1MSW9uVmlydHVhbFNjcm9sbEVsZW1lbnQ7XG4gIHByaXZhdGUgcmVmTWFwID0gbmV3IFdlYWtNYXA8SFRNTEVsZW1lbnQsIEVtYmVkZGVkVmlld1JlZjxWaXJ0dWFsQ29udGV4dD4+KCk7XG5cbiAgQENvbnRlbnRDaGlsZChWaXJ0dWFsSXRlbSwgeyBzdGF0aWM6IGZhbHNlIH0pIGl0bVRtcCE6IFZpcnR1YWxJdGVtO1xuICBAQ29udGVudENoaWxkKFZpcnR1YWxIZWFkZXIsIHsgc3RhdGljOiBmYWxzZSB9KSBoZHJUbXAhOiBWaXJ0dWFsSGVhZGVyO1xuICBAQ29udGVudENoaWxkKFZpcnR1YWxGb290ZXIsIHsgc3RhdGljOiBmYWxzZSB9KSBmdHJUbXAhOiBWaXJ0dWFsRm9vdGVyO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgejogTmdab25lLFxuICAgIHByaXZhdGUgaXRlcmFibGVEaWZmZXJzOiBJdGVyYWJsZURpZmZlcnMsXG4gICAgZWxlbWVudFJlZjogRWxlbWVudFJlZixcbiAgKSB7XG4gICAgdGhpcy5lbCA9IGVsZW1lbnRSZWYubmF0aXZlRWxlbWVudCBhcyBIVE1MSW9uVmlydHVhbFNjcm9sbEVsZW1lbnQ7XG4gICAgdGhpcy5lbC5ub2RlUmVuZGVyID0gdGhpcy5ub2RlUmVuZGVyLmJpbmQodGhpcyk7XG4gIH1cblxuICBuZ09uQ2hhbmdlcyhjaGFuZ2VzOiBTaW1wbGVDaGFuZ2VzKTogdm9pZCB7XG4gICAgaWYgKHRoaXMudHJhY2tCeSAmJiAnaXRlbXMnIGluIGNoYW5nZXMpIHtcbiAgICAgIC8vIFJlYWN0IG9uIHZpcnR1YWxTY3JvbGwgY2hhbmdlcyBvbmx5IG9uY2UgYWxsIGlucHV0cyBoYXZlIGJlZW4gaW5pdGlhbGl6ZWRcbiAgICAgIGNvbnN0IHZhbHVlID0gY2hhbmdlc1snaXRlbXMnXS5jdXJyZW50VmFsdWU7XG4gICAgICBpZiAodGhpcy5kaWZmZXIgPT09IHVuZGVmaW5lZCAmJiB2YWx1ZSAhPSBudWxsKSB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgdGhpcy5kaWZmZXIgPSB0aGlzLml0ZXJhYmxlRGlmZmVycy5maW5kKHZhbHVlKS5jcmVhdGUodGhpcy50cmFja0J5KTtcbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICAgIGBDYW5ub3QgZmluZCBhIGRpZmZlciBzdXBwb3J0aW5nIG9iamVjdCAnJHt2YWx1ZX0nLiBWaXJ0dWFsU2Nyb2xsIG9ubHkgc3VwcG9ydHMgYmluZGluZyB0byBJdGVyYWJsZXMgc3VjaCBhcyBBcnJheXMuYCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBuZ0RvQ2hlY2soKSB7XG4gICAgLy8gYW5kIGlmIHRoZXJlIGFjdHVhbGx5IGFyZSBjaGFuZ2VzXG4gICAgY29uc3QgY2hhbmdlcyA9IHRoaXMuZGlmZmVyICE9PSB1bmRlZmluZWQgJiYgdGhpcy5pdGVtcyA/IHRoaXMuZGlmZmVyLmRpZmYodGhpcy5pdGVtcykgOiBudWxsO1xuICAgIGlmIChjaGFuZ2VzID09PSBudWxsKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIC8vIFRPRE86IG9wdGltaXplXG4gICAgdGhpcy5jaGVja1JhbmdlKDApO1xuICB9XG5cbiAgcHJpdmF0ZSBub2RlUmVuZGVyKGVsOiBIVE1MRWxlbWVudCB8IG51bGwsIGNlbGw6IENlbGwsIGluZGV4OiBudW1iZXIpOiBIVE1MRWxlbWVudCB7XG4gICAgcmV0dXJuIHRoaXMuei5ydW4oKCkgPT4ge1xuICAgICAgbGV0IG5vZGU6IEVtYmVkZGVkVmlld1JlZjxWaXJ0dWFsQ29udGV4dD47XG4gICAgICBpZiAoIWVsKSB7XG4gICAgICAgIG5vZGUgPSB0aGlzLml0bVRtcC52aWV3Q29udGFpbmVyLmNyZWF0ZUVtYmVkZGVkVmlldyhcbiAgICAgICAgICB0aGlzLmdldENvbXBvbmVudChjZWxsLnR5cGUpLFxuICAgICAgICAgIHsgJGltcGxpY2l0OiBjZWxsLnZhbHVlLCBpbmRleCB9LFxuICAgICAgICAgIGluZGV4XG4gICAgICAgICk7XG4gICAgICAgIGVsID0gZ2V0RWxlbWVudChub2RlKTtcbiAgICAgICAgdGhpcy5yZWZNYXAuc2V0KGVsLCBub2RlKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIG5vZGUgPSB0aGlzLnJlZk1hcC5nZXQoZWwpITtcbiAgICAgICAgY29uc3QgY3R4ID0gbm9kZS5jb250ZXh0O1xuICAgICAgICBjdHguJGltcGxpY2l0ID0gY2VsbC52YWx1ZTtcbiAgICAgICAgY3R4LmluZGV4ID0gY2VsbC5pbmRleDtcbiAgICAgIH1cbiAgICAgIC8vIHJ1biBzeW5jIGNoYW5nZSBkZXRlY3Rpb25zXG4gICAgICBub2RlLmRldGVjdENoYW5nZXMoKTtcbiAgICAgIHJldHVybiBlbDtcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0Q29tcG9uZW50KHR5cGU6IENlbGxUeXBlKSB7XG4gICAgc3dpdGNoICh0eXBlKSB7XG4gICAgICBjYXNlICdpdGVtJzogcmV0dXJuIHRoaXMuaXRtVG1wLnRlbXBsYXRlUmVmO1xuICAgICAgY2FzZSAnaGVhZGVyJzogcmV0dXJuIHRoaXMuaGRyVG1wLnRlbXBsYXRlUmVmO1xuICAgICAgY2FzZSAnZm9vdGVyJzogcmV0dXJuIHRoaXMuZnRyVG1wLnRlbXBsYXRlUmVmO1xuICAgIH1cbiAgICB0aHJvdyBuZXcgRXJyb3IoJ3RlbXBsYXRlIGZvciB2aXJ0dWFsIGl0ZW0gd2FzIG5vdCBwcm92aWRlZCcpO1xuICB9XG59XG5cbmNvbnN0IGdldEVsZW1lbnQgPSAodmlldzogRW1iZWRkZWRWaWV3UmVmPFZpcnR1YWxDb250ZXh0Pik6IEhUTUxFbGVtZW50ID0+IHtcbiAgY29uc3Qgcm9vdE5vZGVzID0gdmlldy5yb290Tm9kZXM7XG4gIGZvciAobGV0IGkgPSAwOyBpIDwgcm9vdE5vZGVzLmxlbmd0aDsgaSsrKSB7XG4gICAgaWYgKHJvb3ROb2Rlc1tpXS5ub2RlVHlwZSA9PT0gMSkge1xuICAgICAgcmV0dXJuIHJvb3ROb2Rlc1tpXTtcbiAgICB9XG4gIH1cbiAgdGhyb3cgbmV3IEVycm9yKCd2aXJ0dWFsIGVsZW1lbnQgd2FzIG5vdCBjcmVhdGVkJyk7XG59O1xuIl19